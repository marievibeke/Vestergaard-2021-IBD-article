---
title: "Preperation of HUMAnN data for functional analyses"
output:
  github_document:
    toc: true
editor_options:
  chunk_output_type: console
---
# Load in packages and path to folder
```{r echo=T, message=F, error=F, warning=F}
library(tidyverse)
library(phyloseq)
library(vegan)
library(caret)
path = "C:/Users/Tom/Documents/10. semester/V1/data/"
```

# Prepare and subset the pathway data

Adjust the HUMAnN pathway tables:
```{r}
#Pathway count
path_count <- read.csv(paste0(path, "humann3_processed_output/Joined_tables/", "Joined_pathabundance.tsv"), sep = "\t", strip.white = T, stringsAsFactors = F, row.names = 1)

#Change J-ID:
colnames(path_count) <- substr(colnames(path_count), start = 1, stop = 6)

#Pull out pathways (not divided by taxonomy)
path_count_unstratified <- path_count[grep("\\|", rownames(path_count), value=T, invert=T),]

#Transpose dataframe -> participants as rows
path_count_unstratified <- t(path_count_unstratified)
dim(path_count_unstratified) #209 472
path_count_unstratified <- as.data.frame(path_count_unstratified)
path_count_unstratified$J_ID <- rownames(path_count_unstratified)

#Save
write.table(path_count_unstratified, file=paste0(path, "humann3_processed_output/processed_tables/", "pathway_count_unstratified.txt"), col.names = T, row.names = F, quote = F, sep = '\t')

```

Subset the HUMAnN data based on highest mean and variance for increased power:
```{r}

#Subset based on highest mean and variance
step1.dat <- path_count_unstratified[,-c(473)][ ,colMeans(path_count_unstratified[,-c(473)]) >= quantile( colMeans(path_count_unstratified[,-c(473)]), 0.5) ]
dim(step1.dat) # 209 236
                
# subset to highest mean variance
step2.dat <- apply(step1.dat, 2, var)
step2.dat <- step1.dat[ ,step2.dat >= quantile( step2.dat, 0.50) ]
dim(step2.dat) # 209 118
                
df = cbind(path_count_unstratified$J_ID, step2.dat)
colnames(df)[1] <- "J_ID"
df[1:4,1:4]
dim(df)#119

#Save
write.table(df, file=paste0(path, "humann3_processed_output/processed_tables/", "pathway_count_unstratified_mean50_var50.txt"), col.names = T, row.names = F, quote = F, sep = '\t') 
```

# Prepare and subset the EC data

Read in HUMAnN EC tables:
```{r}
#Pathway abundance
gene_abun <- read.csv(paste0(path, "humann3_processed_output/Joined_tables/", "Joined_genefamilies_relab_EC_rename.tsv"), sep = "\t", strip.white = T, stringsAsFactors = F, row.names = 1)

#Change J-ID:
colnames(gene_abun) <- substr(colnames(gene_abun), start = 1, stop = 6)

#Pull out pathways (not divided by taxonomy)
gene_abun_unstratified <- gene_abun[grep("\\|", rownames(gene_abun), value=T, invert=T),]

#Transpose dataframe -> participants as rows
gene_abun_unstratified <- t(gene_abun_unstratified)
dim(gene_abun_unstratified) #209 2427
gene_abun_unstratified <- as.data.frame(gene_abun_unstratified)
gene_abun_unstratified$J_ID <- rownames(gene_abun_unstratified)

#Save
write.table(gene_abun_unstratified, file=paste0(path, "humann3_processed_output/processed_tables/", "EC_relab_unstratified.txt"), col.names = T, row.names = F, quote = F, sep = '\t')

```

Subset EC dataframe based on highest mean and variance:
```{r}
only_path <- gene_abun_unstratified %>% dplyr::select(c(3:2427))
df <- cbind(gene_abun_unstratified$J_ID,gene_abun_unstratified$UNMAPPED,gene_abun_unstratified$UNGROUPED, only_path)

#Subset based on highest mean and variance
# subset to highest mean abundance
step1.dat <- df[,-c(1)][ ,colMeans(df[,-c(1)]) >= quantile( colMeans(df[,-c(1)]), 0.75) ]
dim(step1.dat)# 209 607
                
# subset to highest mean variance
step2.dat <- apply(step1.dat, 2, var)
step2.dat <- step1.dat[ ,step2.dat >= quantile( step2.dat, 0.75) ]
dim(step2.dat) # 209 152
                
df = cbind(df[,1], step2.dat)
colnames(df)[1] <- "J_ID"
colnames(df)[2] <- "UNMAPPED"
colnames(df)[3] <- "UNINTEGRATED"
df[1:4,1:4]

#Save
write.table(df, file=paste0(path, "humann3_processed_output/processed_tables/", "EC_relab_unstratified_mean75_var75.txt"), col.names = T, row.names = F, quote = F, sep = '\t')  
```

# Prepare and subset the KO data

Read in HUMAnN KO tables:
```{r}
gene_abun <- read.csv(paste0(path, "humann3_processed_output/Joined_tables/", "Joined_genefamilies_relab_KO_rename.tsv"), sep = "\t", strip.white = T, stringsAsFactors = F, row.names = 1)

#Change J-ID:
colnames(gene_abun) <- substr(colnames(gene_abun), start = 1, stop = 6)

#Pull out pathways (not divided by taxonomy)
gene_abun_unstratified <- gene_abun[grep("\\|", rownames(gene_abun), value=T, invert=T),]

#Transpose dataframe -> participants as rows
gene_abun_unstratified <- t(gene_abun_unstratified)
dim(gene_abun_unstratified) #209 6177
gene_abun_unstratified <- as.data.frame(gene_abun_unstratified)
gene_abun_unstratified$J_ID <- rownames(gene_abun_unstratified)

#Save
write.table(gene_abun_unstratified, file=paste0(path, "humann3_processed_output/processed_tables/", "KO_relab_unstratified.txt"), col.names = T, row.names = F, quote = F, sep = '\t')

```

Subset KO dataframe based on highest mean and variance:
```{r}
only_path <- gene_abun_unstratified %>% dplyr::select(c(3:6177))
df <- cbind(gene_abun_unstratified$J_ID,gene_abun_unstratified$UNMAPPED,gene_abun_unstratified$UNGROUPED, only_path)

# subset to highest mean abundance
step1.dat <- df[,-c(1)][ ,colMeans(df[,-c(1)]) >= quantile( colMeans(df[,-c(1)]), 0.75) ]
dim(step1.dat) #209 1545
                
# subset to highest mean variance
step2.dat <- apply(step1.dat, 2, var)
step2.dat <- step1.dat[ ,step2.dat >= quantile( step2.dat, 0.75) ]
dim(step2.dat) # 209 387
                
df = cbind(df[,1], step2.dat)
colnames(df)[1] <- "J_ID"
colnames(df)[2] <- "UNMAPPED"
colnames(df)[3] <- "UNINTEGRATED"
df[1:4,1:4]

#Save
write.table(df, file=paste0(path, "humann3_processed_output/processed_tables/", "KO_relab_unstratified_mean75_var75.txt"), col.names = T, row.names = F, quote = F, sep = '\t') 

```

